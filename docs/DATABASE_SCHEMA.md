# Database Schema - Advanced Crypto Trading Bot

Êú¨„Éâ„Ç≠„É•„É°„É≥„Éà„Åß„ÅØ„ÄÅSupabase PostgreSQL „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Çπ„Ç≠„Éº„ÉûË®≠Ë®à„ÄÅ„ÉÜ„Éº„Éñ„É´ÊßãÈÄ†„ÄÅ„É™„É¨„Éº„Ç∑„Éß„É≥„ÄÅÂà∂Á¥Ñ„Å´„Å§„ÅÑ„Å¶Ë©≥Á¥∞„Å´Ë™¨Êòé„Åó„Åæ„Åô„ÄÇ

**„Éá„Éº„Çø„Éô„Éº„Çπ**: Supabase PostgreSQL 15.x
**ÊñáÂ≠ó„Çª„ÉÉ„Éà**: UTF-8
**ÊúÄÁµÇÊõ¥Êñ∞**: 2025-07-15

---

## üèóÔ∏è „Éá„Éº„Çø„Éô„Éº„ÇπÊ¶ÇË¶Å

### Ë®≠Ë®àÂéüÂâá

1. **Ê≠£Ë¶èÂåñ**: Á¨¨3Ê≠£Ë¶èÂΩ¢„Åæ„ÅßÊ≠£Ë¶èÂåñ„Åó„Å¶„Éá„Éº„ÇøÈáçË§á„ÇíÊéíÈô§
2. **„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ**: ÈÅ©Âàá„Å™„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË®≠Ë®à„Åß„ÇØ„Ç®„É™ÊúÄÈÅ©Âåñ
3. **„Çª„Ç≠„É•„É™„ÉÜ„Ç£**: Row Level Security (RLS) „Åß„Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°
4. **Êã°ÂºµÊÄß**: UUID‰∏ª„Ç≠„Éº„Åß„Çπ„Ç±„Éº„É©„Éñ„É´Ë®≠Ë®à
5. **Áõ£Êüª**: created_at, updated_at „ÅßÂ§âÊõ¥Â±•Ê≠¥ËøΩË∑°

### ÂÖ®‰ΩìERÂõ≥

```mermaid
erDiagram
    %% Core Auth (Supabase managed)
    auth_users {
        uuid id PK
        string email
        timestamp created_at
        jsonb user_metadata
    }

    %% User Management
    profiles {
        uuid id PK,FK
        string username
        string email
        string role
        timestamp created_at
        timestamp updated_at
    }

    exchanges {
        uuid id PK
        uuid user_id FK
        string name
        string api_key_encrypted
        string api_secret_encrypted
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    %% Trading System
    strategies {
        uuid id PK
        uuid user_id FK
        string name
        text description
        jsonb parameters
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    trades {
        uuid id PK
        uuid user_id FK
        uuid strategy_id FK
        uuid exchange_id FK
        string symbol
        string side
        string type
        decimal amount
        decimal price
        decimal fee
        string order_id
        timestamp timestamp
        timestamp created_at
    }

    positions {
        uuid id PK
        uuid user_id FK
        string symbol
        decimal amount
        decimal average_entry_price
        decimal unrealized_pnl
        timestamp last_updated
        timestamp created_at
    }

    %% Analytics & Testing
    backtest_results {
        uuid id PK
        uuid user_id FK
        uuid strategy_id FK
        string start_period
        string end_period
        jsonb results_data
        timestamp created_at
    }

    %% Market Data
    market_data {
        uuid id PK
        string symbol
        string timeframe
        decimal open_price
        decimal high_price
        decimal low_price
        decimal close_price
        decimal volume
        timestamp timestamp
        timestamp created_at
    }

    %% Relationships
    auth_users ||--|| profiles : "1:1"
    profiles ||--o{ exchanges : "1:many"
    profiles ||--o{ strategies : "1:many"
    profiles ||--o{ trades : "1:many"
    profiles ||--o{ positions : "1:many"
    profiles ||--o{ backtest_results : "1:many"
    strategies ||--o{ trades : "1:many"
    strategies ||--o{ backtest_results : "1:many"
    exchanges ||--o{ trades : "1:many"
```

---

## üìã „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞‰ªïÊßò

### 1. profiles („É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç°„Ç§„É´)

„É¶„Éº„Ç∂„Éº„ÅÆÂü∫Êú¨ÊÉÖÂ†±„Å®„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255),
    role VARCHAR(20) DEFAULT 'viewer' CHECK (role IN ('admin', 'trader', 'viewer')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### „Ç´„É©„É†Ë©≥Á¥∞

| „Ç´„É©„É† | Âûã | Âà∂Á¥Ñ | Ë™¨Êòé |
|--------|----|----- |------|
| `id` | UUID | PK, FK | auth.users.id „Å∏„ÅÆÂ§ñÈÉ®„Ç≠„Éº |
| `username` | VARCHAR(50) | UNIQUE, NOT NULL | ‰∏ÄÊÑè„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç |
| `email` | VARCHAR(255) | - | „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºàË™çË®ºÁî®Ôºâ |
| `role` | VARCHAR(20) | CHECK | „É¶„Éº„Ç∂„Éº„É≠„Éº„É´ (admin/trader/viewer) |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | ‰ΩúÊàêÊó•ÊôÇ |
| `updated_at` | TIMESTAMPTZ | DEFAULT NOW() | Êõ¥Êñ∞Êó•ÊôÇ |

#### RLS „Éù„É™„Ç∑„Éº

```sql
-- „É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
CREATE POLICY "Users can view own profile" ON profiles
FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
FOR UPDATE USING (auth.uid() = id);
```

---

### 2. exchanges (ÂèñÂºïÊâÄÈÄ£Êê∫)

„É¶„Éº„Ç∂„Éº„ÅÆÂèñÂºïÊâÄAPIË™çË®ºÊÉÖÂ†±„ÇíÂÆâÂÖ®„Å´ÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE exchanges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL CHECK (name IN ('binance', 'bybit', 'okx', 'ftx')),
    api_key_encrypted TEXT NOT NULL,
    api_secret_encrypted TEXT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(user_id, name)
);
```

#### „Ç´„É©„É†Ë©≥Á¥∞

| „Ç´„É©„É† | Âûã | Âà∂Á¥Ñ | Ë™¨Êòé |
|--------|----|----- |------|
| `id` | UUID | PK | ‰∏ÄÊÑèË≠òÂà•Â≠ê |
| `user_id` | UUID | FK, NOT NULL | „Éó„É≠„Éï„Ç°„Ç§„É´„Å∏„ÅÆÂ§ñÈÉ®„Ç≠„Éº |
| `name` | VARCHAR(50) | CHECK | ÂèñÂºïÊâÄÂêç (binance/bybit/okx/ftx) |
| `api_key_encrypted` | TEXT | NOT NULL | ÊöóÂè∑Âåñ„Åï„Çå„ÅüAPI„Ç≠„Éº |
| `api_secret_encrypted` | TEXT | NOT NULL | ÊöóÂè∑Âåñ„Åï„Çå„ÅüAPI„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà |
| `is_active` | BOOLEAN | DEFAULT TRUE | ÊúâÂäπ/ÁÑ°Âäπ„Éï„É©„Ç∞ |

#### „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÄÉÊÖÆ‰∫ãÈ†Ö

- APIË™çË®ºÊÉÖÂ†±„ÅØ**AES-256**„ÅßÊöóÂè∑Âåñ„Åó„Å¶‰øùÂ≠ò
- **Áí∞Â¢ÉÂ§âÊï∞**„ÅßÊöóÂè∑Âåñ„Ç≠„Éº„ÇíÁÆ°ÁêÜ
- **ÂÆöÊúüÁöÑ„Å™„Ç≠„Éº„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥**„ÇíÂÆüË£Ö‰∫àÂÆö

---

### 3. strategies (ÂèñÂºïÊà¶Áï•)

„É¶„Éº„Ç∂„Éº„Åå‰ΩúÊàê„Åó„ÅüÂèñÂºïÊà¶Áï•„ÅÆÂÆöÁæ©„Å®Ë®≠ÂÆö„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE strategies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parameters JSONB NOT NULL DEFAULT '{}',
    is_active BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(user_id, name)
);
```

#### parameters JSON ÊßãÈÄ†‰æã

```json
{
  "symbol": "BTCUSDT",
  "timeframe": "1h",
  "indicators": {
    "ema_fast": 12,
    "ema_slow": 26,
    "rsi_period": 14,
    "bb_period": 20
  },
  "risk_management": {
    "max_position_size": 0.1,
    "stop_loss_pct": 0.02,
    "take_profit_pct": 0.04
  },
  "entry_conditions": [
    "ema_cross_up",
    "rsi_oversold"
  ],
  "exit_conditions": [
    "ema_cross_down",
    "stop_loss",
    "take_profit"
  ]
}
```

#### „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

```sql
CREATE INDEX idx_strategies_user_active ON strategies (user_id, is_active);
CREATE INDEX idx_strategies_parameters ON strategies USING GIN (parameters);
```

---

### 4. trades (ÂèñÂºïÂ±•Ê≠¥)

ÂÆüË°å„Åï„Çå„ÅüÂèñÂºï„ÅÆË©≥Á¥∞Ë®òÈå≤„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE trades (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    strategy_id UUID REFERENCES strategies(id) ON DELETE SET NULL,
    exchange_id UUID REFERENCES exchanges(id) ON DELETE SET NULL,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL CHECK (side IN ('buy', 'sell')),
    type VARCHAR(20) NOT NULL CHECK (type IN ('market', 'limit', 'stop', 'stop_limit')),
    amount DECIMAL(20, 8) NOT NULL CHECK (amount > 0),
    price DECIMAL(20, 8) NOT NULL CHECK (price > 0),
    fee DECIMAL(20, 8) DEFAULT 0,
    order_id VARCHAR(100),
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### „Ç´„É©„É†Ë©≥Á¥∞

| „Ç´„É©„É† | Âûã | Âà∂Á¥Ñ | Ë™¨Êòé |
|--------|----|----- |------|
| `id` | UUID | PK | ‰∏ÄÊÑèË≠òÂà•Â≠ê |
| `user_id` | UUID | FK, NOT NULL | „É¶„Éº„Ç∂„ÉºID |
| `strategy_id` | UUID | FK | Êà¶Áï•IDÔºàÊâãÂãïÂèñÂºï„ÅÆÂ†¥Âêà„ÅØNULLÔºâ |
| `exchange_id` | UUID | FK | ÂèñÂºïÊâÄID |
| `symbol` | VARCHAR(20) | NOT NULL | ÈÄöË≤®„Éö„Ç¢ (BTCUSDTÁ≠â) |
| `side` | VARCHAR(10) | CHECK | Â£≤Ë≤∑ÊñπÂêë (buy/sell) |
| `type` | VARCHAR(20) | CHECK | Ê≥®Êñá„Çø„Ç§„Éó |
| `amount` | DECIMAL(20,8) | CHECK > 0 | ÂèñÂºïÈáè |
| `price` | DECIMAL(20,8) | CHECK > 0 | Á¥ÑÂÆö‰æ°Ê†º |
| `fee` | DECIMAL(20,8) | DEFAULT 0 | ÊâãÊï∞Êñô |
| `order_id` | VARCHAR(100) | - | ÂèñÂºïÊâÄÊ≥®ÊñáID |
| `timestamp` | TIMESTAMPTZ | NOT NULL | Á¥ÑÂÆöÊó•ÊôÇ |

#### „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ

```sql
-- ÊôÇÁ≥ªÂàó„ÇØ„Ç®„É™ÊúÄÈÅ©Âåñ
CREATE INDEX idx_trades_user_timestamp ON trades (user_id, timestamp DESC);
CREATE INDEX idx_trades_strategy_timestamp ON trades (strategy_id, timestamp DESC);
CREATE INDEX idx_trades_symbol_timestamp ON trades (symbol, timestamp DESC);
```

---

### 5. positions („Éù„Ç∏„Ç∑„Éß„É≥ÁÆ°ÁêÜ)

ÁèæÂú®‰øùÊúâ‰∏≠„ÅÆ„Éù„Ç∏„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE positions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    symbol VARCHAR(20) NOT NULL,
    amount DECIMAL(20, 8) NOT NULL,
    average_entry_price DECIMAL(20, 8) NOT NULL CHECK (average_entry_price > 0),
    unrealized_pnl DECIMAL(20, 8) DEFAULT 0,
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(user_id, symbol)
);
```

#### „Éì„Ç∏„Éç„Çπ„É≠„Ç∏„ÉÉ„ÇØ

- `amount > 0`: „É≠„É≥„Ç∞„Éù„Ç∏„Ç∑„Éß„É≥
- `amount < 0`: „Ç∑„Éß„Éº„Éà„Éù„Ç∏„Ç∑„Éß„É≥
- `amount = 0`: „Éù„Ç∏„Ç∑„Éß„É≥„ÇØ„É≠„Éº„Ç∫Ôºà„É¨„Ç≥„Éº„ÉâÂâäÈô§Ôºâ

#### Ëá™ÂãïÊõ¥Êñ∞„Éà„É™„Ç¨„Éº

```sql
-- „Éù„Ç∏„Ç∑„Éß„É≥Ëá™ÂãïÊõ¥Êñ∞„Éà„É™„Ç¨„Éº
CREATE OR REPLACE FUNCTION update_position_on_trade()
RETURNS TRIGGER AS $$
BEGIN
    -- ÂèñÂºï„Å´Âü∫„Å•„ÅÑ„Å¶„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
    INSERT INTO positions (user_id, symbol, amount, average_entry_price)
    VALUES (NEW.user_id, NEW.symbol,
            CASE WHEN NEW.side = 'buy' THEN NEW.amount ELSE -NEW.amount END,
            NEW.price)
    ON CONFLICT (user_id, symbol)
    DO UPDATE SET
        amount = positions.amount +
                CASE WHEN NEW.side = 'buy' THEN NEW.amount ELSE -NEW.amount END,
        average_entry_price =
            CASE
                WHEN positions.amount + CASE WHEN NEW.side = 'buy' THEN NEW.amount ELSE -NEW.amount END = 0
                THEN 0
                ELSE (positions.average_entry_price * ABS(positions.amount) + NEW.price * NEW.amount) /
                     ABS(positions.amount + CASE WHEN NEW.side = 'buy' THEN NEW.amount ELSE -NEW.amount END)
            END,
        last_updated = NOW();

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_position_on_trade
    AFTER INSERT ON trades
    FOR EACH ROW
    EXECUTE FUNCTION update_position_on_trade();
```

---

### 6. backtest_results („Éê„ÉÉ„ÇØ„ÉÜ„Çπ„ÉàÁµêÊûú)

Êà¶Áï•„ÅÆ„Éê„ÉÉ„ÇØ„ÉÜ„Çπ„ÉàÁµêÊûú„Å®ÊÄßËÉΩÊåáÊ®ô„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE backtest_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    strategy_id UUID NOT NULL REFERENCES strategies(id) ON DELETE CASCADE,
    start_period VARCHAR(10) NOT NULL,
    end_period VARCHAR(10) NOT NULL,
    results_data JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### results_data JSON ÊßãÈÄ†

```json
{
  "performance": {
    "total_return": 0.156,
    "annualized_return": 0.234,
    "sharpe_ratio": 1.45,
    "sortino_ratio": 1.62,
    "max_drawdown": 0.087,
    "calmar_ratio": 2.69
  },
  "trading_stats": {
    "total_trades": 245,
    "winning_trades": 152,
    "losing_trades": 93,
    "win_rate": 0.62,
    "avg_winning_trade": 0.024,
    "avg_losing_trade": -0.018,
    "profit_factor": 2.13
  },
  "risk_metrics": {
    "value_at_risk_95": 0.034,
    "expected_shortfall": 0.052,
    "beta": 1.08,
    "alpha": 0.045
  },
  "monthly_returns": [
    {"month": "2024-01", "return": 0.023},
    {"month": "2024-02", "return": -0.011}
  ]
}
```

---

### 7. market_data (Â∏ÇÂ†¥„Éá„Éº„Çø)

ÊöóÂè∑ÈÄöË≤®„ÅÆ‰æ°Ê†º„Éá„Éº„ÇøÔºàOHLCVÔºâ„ÇíÊôÇÁ≥ªÂàó„Åß‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE market_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL CHECK (timeframe IN ('1m', '5m', '15m', '1h', '4h', '1d')),
    open_price DECIMAL(20, 8) NOT NULL CHECK (open_price > 0),
    high_price DECIMAL(20, 8) NOT NULL CHECK (high_price > 0),
    low_price DECIMAL(20, 8) NOT NULL CHECK (low_price > 0),
    close_price DECIMAL(20, 8) NOT NULL CHECK (close_price > 0),
    volume DECIMAL(20, 8) NOT NULL CHECK (volume >= 0),
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(symbol, timeframe, timestamp)
);
```

#### Âà∂Á¥Ñ„Å®„Éê„É™„Éá„Éº„Ç∑„Éß„É≥

```sql
-- ‰æ°Ê†º„ÅÆÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
ALTER TABLE market_data ADD CONSTRAINT check_price_consistency
CHECK (
    low_price <= open_price AND
    low_price <= close_price AND
    high_price >= open_price AND
    high_price >= close_price
);
```

#### „Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„Éã„É≥„Ç∞ÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ

```sql
-- ÊôÇÁ≥ªÂàó„Éá„Éº„Çø„ÅÆ„Éë„Éº„ÉÜ„Ç£„Ç∑„Éß„Éã„É≥„Ç∞
CREATE TABLE market_data_2024 PARTITION OF market_data
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

CREATE TABLE market_data_2025 PARTITION OF market_data
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
```

#### È´òÊÄßËÉΩ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

```sql
-- ÊôÇÁ≥ªÂàó„ÇØ„Ç®„É™ÊúÄÈÅ©Âåñ
CREATE INDEX idx_market_data_symbol_timeframe_timestamp
ON market_data (symbol, timeframe, timestamp DESC);

-- ‰æ°Ê†ºÁØÑÂõ≤Ê§úÁ¥¢ÊúÄÈÅ©Âåñ
CREATE INDEX idx_market_data_price_range
ON market_data (symbol, timestamp)
INCLUDE (open_price, high_price, low_price, close_price);
```

---

## üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö

### Row Level Security (RLS)

„Åô„Åπ„Å¶„ÅÆ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´„Å´RLS„ÇíÈÅ©Áî®Ôºö

```sql
-- RLSÊúâÂäπÂåñ
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE exchanges ENABLE ROW LEVEL SECURITY;
ALTER TABLE strategies ENABLE ROW LEVEL SECURITY;
ALTER TABLE trades ENABLE ROW LEVEL SECURITY;
ALTER TABLE positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE backtest_results ENABLE ROW LEVEL SECURITY;

-- ÂÖ±ÈÄö„Éù„É™„Ç∑„Éº: „É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
CREATE POLICY "Users access own data" ON exchanges
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "Users access own data" ON strategies
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "Users access own data" ON trades
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "Users access own data" ON positions
FOR ALL USING (user_id = auth.uid());

CREATE POLICY "Users access own data" ON backtest_results
FOR ALL USING (user_id = auth.uid());
```

### ÊöóÂè∑Âåñ

```sql
-- ÊöóÂè∑ÂåñÈñ¢Êï∞Ôºàpgcrypto‰ΩøÁî®Ôºâ
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- API „Ç≠„ÉºÊöóÂè∑Âåñ
CREATE OR REPLACE FUNCTION encrypt_api_key(api_key TEXT, user_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(encrypt(api_key::bytea, (user_id::text || current_setting('app.encryption_key'))::bytea, 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- API „Ç≠„ÉºÂæ©Âè∑Âåñ
CREATE OR REPLACE FUNCTION decrypt_api_key(encrypted_key TEXT, user_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN decrypt(decode(encrypted_key, 'base64'), (user_id::text || current_setting('app.encryption_key'))::bytea, 'aes')::text;
END;
$$ LANGUAGE plpgsql;
```

---

## üìä „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ

### „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊà¶Áï•

```sql
-- È†ªÁπÅ„Å™„ÇØ„Ç®„É™„Éë„Çø„Éº„É≥„Å´Âü∫„Å•„Åè„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË®≠Ë®à

-- 1. „É¶„Éº„Ç∂„Éº„Éô„Éº„Çπ„ÅÆÊ§úÁ¥¢
CREATE INDEX CONCURRENTLY idx_trades_user_id ON trades (user_id);
CREATE INDEX CONCURRENTLY idx_strategies_user_id ON strategies (user_id);

-- 2. ÊôÇÁ≥ªÂàóÊ§úÁ¥¢
CREATE INDEX CONCURRENTLY idx_trades_timestamp ON trades (timestamp DESC);
CREATE INDEX CONCURRENTLY idx_market_data_timestamp ON market_data (timestamp DESC);

-- 3. Ë§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºà„Ç´„Éê„É™„É≥„Ç∞„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºâ
CREATE INDEX CONCURRENTLY idx_trades_user_symbol_timestamp
ON trades (user_id, symbol, timestamp DESC)
INCLUDE (amount, price, side);

-- 4. JSONBÊ§úÁ¥¢ÊúÄÈÅ©Âåñ
CREATE INDEX CONCURRENTLY idx_strategies_parameters_gin
ON strategies USING GIN (parameters);

-- 5. ÈÉ®ÂàÜ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºà„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
CREATE INDEX CONCURRENTLY idx_strategies_active
ON strategies (user_id, name)
WHERE is_active = true;
```

### „ÇØ„Ç®„É™ÊúÄÈÅ©Âåñ‰æã

```sql
-- ÂäπÁéáÁöÑ„Å™ÂèñÂºïÂ±•Ê≠¥ÂèñÂæó
EXPLAIN (ANALYZE, BUFFERS)
SELECT t.*, s.name as strategy_name
FROM trades t
LEFT JOIN strategies s ON t.strategy_id = s.id
WHERE t.user_id = $1
AND t.timestamp >= $2
ORDER BY t.timestamp DESC
LIMIT 50;

-- „Éû„ÉÜ„É™„Ç¢„É©„Ç§„Ç∫„Éâ„Éì„É•„ÉºÔºàÈõÜË®à„Éá„Éº„ÇøÔºâ
CREATE MATERIALIZED VIEW daily_portfolio_summary AS
SELECT
    user_id,
    DATE(timestamp) as trade_date,
    SUM(CASE WHEN side = 'buy' THEN amount * price ELSE -amount * price END) as net_flow,
    COUNT(*) as trade_count,
    AVG(fee) as avg_fee
FROM trades
GROUP BY user_id, DATE(timestamp);

-- ÂÆöÊúüÊõ¥Êñ∞
CREATE UNIQUE INDEX ON daily_portfolio_summary (user_id, trade_date);
```

---

## üîÑ „Éá„Éº„Çø„É°„É≥„ÉÜ„Éä„É≥„Çπ

### Ëá™Âãï„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó

```sql
-- Âè§„ÅÑÂ∏ÇÂ†¥„Éá„Éº„Çø„ÅÆËá™ÂãïÂâäÈô§Ôºà1Âπ¥‰ª•‰∏äÂâçÔºâ
CREATE OR REPLACE FUNCTION cleanup_old_market_data()
RETURNS void AS $$
BEGIN
    DELETE FROM market_data
    WHERE created_at < NOW() - INTERVAL '1 year';

    RAISE NOTICE 'Cleaned up old market data';
END;
$$ LANGUAGE plpgsql;

-- ÊØéÊó•ÂÆüË°å
SELECT cron.schedule('cleanup-market-data', '0 2 * * *', 'SELECT cleanup_old_market_data();');
```

### „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊà¶Áï•

```sql
-- Á∂ôÁ∂öÁöÑ„Ç¢„Éº„Ç´„Ç§„Éñ„É≠„Ç∞
ALTER SYSTEM SET wal_level = replica;
ALTER SYSTEM SET archive_mode = on;
ALTER SYSTEM SET archive_command = 'cp %p /backup/wal_archive/%f';

-- „Éù„Ç§„É≥„Éà„Ç§„É≥„Çø„Ç§„É†„É™„Ç´„Éê„É™ÂØæÂøú
SELECT pg_start_backup('daily_backup', false);
-- „Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„É¨„Éô„É´„Åß„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°å
SELECT pg_stop_backup();
```

---

## üìà Áõ£Ë¶ñ„Éª„É°„Éà„É™„ÇØ„Çπ

### „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ„ÇØ„Ç®„É™

```sql
-- „ÉÜ„Éº„Éñ„É´„Çµ„Ç§„Ç∫Áõ£Ë¶ñ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY bytes DESC;

-- „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩøÁî®Áä∂Ê≥Å
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- „Çπ„É≠„Éº„ÇØ„Ç®„É™Áõ£Ë¶ñ
SELECT
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

---

## üïí Phase2„ÅßËøΩÂä†„Åï„Çå„Åü„ÉÜ„Éº„Éñ„É´

### 8. price_data (‰æ°Ê†º„Éá„Éº„Çø)

ÂèñÂºïÊâÄ„Åã„ÇâÂèéÈõÜ„Åó„ÅüOHLCV‰æ°Ê†º„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇPhase2„Éá„Éº„Çø„Éë„Ç§„Éó„É©„Ç§„É≥„ÅßËøΩÂä†„ÄÇ

```sql
CREATE TABLE price_data (
    id BIGSERIAL PRIMARY KEY,
    exchange VARCHAR(20) NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    open_price NUMERIC(20,8) NOT NULL,
    high_price NUMERIC(20,8) NOT NULL,
    low_price NUMERIC(20,8) NOT NULL,
    close_price NUMERIC(20,8) NOT NULL,
    volume NUMERIC(20,8) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(exchange, symbol, timeframe, timestamp)
);

-- „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
CREATE INDEX idx_price_data_exchange_symbol ON price_data(exchange, symbol);
CREATE INDEX idx_price_data_timeframe ON price_data(timeframe);
CREATE INDEX idx_price_data_timestamp ON price_data(timestamp DESC);
CREATE INDEX idx_price_data_composite ON price_data(exchange, symbol, timeframe, timestamp DESC);
```

#### „Ç´„É©„É†Ë©≥Á¥∞

| „Ç´„É©„É† | Âûã | Âà∂Á¥Ñ | Ë™¨Êòé |
|--------|----|----- |------|
| `id` | BIGSERIAL | PK | Ëá™ÂãïÂ¢óÂàÜID |
| `exchange` | VARCHAR(20) | NOT NULL | ÂèñÂºïÊâÄÂêç (binance, bybit) |
| `symbol` | VARCHAR(20) | NOT NULL | ÂèñÂºï„Éö„Ç¢ (BTCUSDT, ETHUSDT) |
| `timeframe` | VARCHAR(10) | NOT NULL | ÊôÇÈñìË∂≥ (1m, 5m, 1h, 1d) |
| `timestamp` | TIMESTAMPTZ | NOT NULL | „Éá„Éº„ÇøÊôÇÂàª |
| `open_price` | NUMERIC(20,8) | NOT NULL | ÈñãÂßã‰æ°Ê†º |
| `high_price` | NUMERIC(20,8) | NOT NULL | ÊúÄÈ´ò‰æ°Ê†º |
| `low_price` | NUMERIC(20,8) | NOT NULL | ÊúÄ‰Ωé‰æ°Ê†º |
| `close_price` | NUMERIC(20,8) | NOT NULL | ÁµÇ‰∫Ü‰æ°Ê†º |
| `volume` | NUMERIC(20,8) | NOT NULL | Âá∫Êù•È´ò |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | ‰ΩúÊàêÊó•ÊôÇ |

#### ÁâπÂæ¥

- **È´òÁ≤æÂ∫¶‰æ°Ê†º**: NUMERIC(20,8)„ÅßÊöóÂè∑ÈÄöË≤®„ÅÆÂ∞èÊï∞ÁÇπ„ÇíÊ≠£Á¢∫„Å´‰øùÂ≠ò
- **ÈáçË§áÈò≤Ê≠¢**: ÂèñÂºïÊâÄ„Éª„Ç∑„É≥„Éú„É´„ÉªÊôÇÈñìË∂≥„Éª„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åß„É¶„Éã„Éº„ÇØÂà∂Á¥Ñ
- **„Éë„Éñ„É™„ÉÉ„ÇØ„Éá„Éº„Çø**: RLS„Åßread„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÄÅÁÆ°ÁêÜ„ÅØ„Çµ„Éº„Éì„Çπ„É¨„Éô„É´
- **„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊúÄÈÅ©Âåñ**: Ê§úÁ¥¢„Éë„Çø„Éº„É≥„Å´Âü∫„Å•„ÅÑ„ÅüË§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

---

**„Åì„ÅÆÂåÖÊã¨ÁöÑ„Å™„Çπ„Ç≠„Éº„ÉûË®≠Ë®à„Å´„Çà„Çä„ÄÅ„Çπ„Ç±„Éº„É©„Éñ„É´„ÅßÂÆâÂÖ®„Å™ÊöóÂè∑ÈÄöË≤®ÂèñÂºï„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éá„Éº„ÇøÂ±§„ÇíÂÆüÁèæ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ**
